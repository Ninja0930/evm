import { expect } from 'chai';
import { ethers } from 'hardhat';
import { SignerWithAddress } from '@nomiclabs/hardhat-ethers/signers';
import { Contract } from 'ethers';
import { loadFixture } from '@nomicfoundation/hardhat-network-helpers';

describe('NestingMock', function () {
  let parent: Contract;
  let child: Contract;
  let spammer: Contract;
  let owner: SignerWithAddress;

  const name = 'ownerChunky';
  const symbol = 'CHNKY';

  const name2 = 'petMonkey';
  const symbol2 = 'MONKE';

  async function nestingFixture() {
    const NestingFactory = await ethers.getContractFactory('RMRKNestingMock');
    parent = await NestingFactory.deploy(name, symbol);
    await parent.deployed();

    child = await NestingFactory.deploy(name2, symbol2);
    await child.deployed();

    const ChildSpammer = await ethers.getContractFactory('ChildSpammer');
    spammer = await ChildSpammer.deploy();
    await spammer.deployed();

    return { parent, child, spammer };
  }

  beforeEach(async function () {
    owner = (await ethers.getSigners())[0];
    ({ parent, child, spammer } = await loadFixture(nestingFixture));
  });

  describe('spam children', async function () {
    it('Cannot add multiple chilren', async function () {
      await parent.connect(owner).mint(owner.address, 1);
      // await parent.connect(owner).mint(child.address, 2);
      // Propose 10 children with the same params to the parent token
      await spammer.spamChild(parent.address, 1, 1, 10);

      console.log(parent.address);
      console.log(owner.address);
      console.log(await parent.ownerOf(1));

      await parent.connect(owner).acceptChild(1, 0);
      await expect(parent.connect(owner).acceptChild(1, 0)).to.be.revertedWithCustomError(
        parent,
        'RMRKChildAlreadyExists',
      );
    });
  });
});
